const CHAIN_PNG = {
  56: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAA8FBMVEUAAAD/vzD2vjP0uzHzvDD0uzD0uy/zujD0uy/0ujDzuzD0ui//v0D1vTH0uzDzuy/0ui/zui//1VXzvTLzuzDzuzD0uzD2uzLzuzDzui/3vzD1uy/zuy/1ujHzuzD0uy/3vDL0ujD0ujH2vzfzujD/v0D0uzDzuy/3vTH0ujD0vDH2wTXzujD1uzD//4D0ujD0uy//xDv0uzDzxTr0ujD/wjH3vTHzuzD53Jf////0uzDzuy/43Jb54ab54qf2z3H20HLzujD65rT657fzujHzuzL0vDD657j0ujD303r303z65rX65rb30XT20HP43JWoxssAAAAASXRSTlMAEDdeham4xdLf7PkMSYvC6f8GQoTG+ziV7SB82TSv/j25QxyrBHTzPtSIHcRLAomoDbsWzBUf2v//daz/////////////X/+GTDbMXAAABExJREFUeAG81NWBBCEQRdFxt8e4u7S75h/Y/o9CNexJ4BZaIilXqrV6o9lqd7rdTrvVbNRr1Uq59C96/cFwhLdGw0G/pzTOxpPpDF/NppMxU5SfL5bgslzM5ddX6w0EbNYrqfntbg9B+91WWv5wBMnxICV/GoJseCqcP19QyOVcKH+93VHQ/Xal9x8aJNAe1OXre0ix16+UvmFCGpNwE6wOJOpYgnnb2UOqvWOL9JkL6VzG3/d8KOB7vP0ghBJhxNePEyiSxFzrT6BMEnCcfwiFwp/3gPlQymff+7YLxdzv/4ED5ZxvfWsPQWkKQfsvv7LREe5nmfAEHeNT/2oS+oQJzGvpPZ3QJ02gv+8/9oQ+aYL94+0BaIQ+cQLt3SHkhD55gvy1f76T+4QJ7n+kmAVia1EIRCfuQt11D9+5dZf97+a7vWkb4DEbOKdNwh04BudznJ8x+AzKUZIfNuCdaRblZw1mtH9G+XmD6uZ6mOdHDQ4r+3+O/zdfJJBd/Mtenh832MPfbO3n+XGD/S38yXaCnzDYxp+8T/ATBjt/728JvpaEwTp+ZaM+v4gkDDbwM0ub4suX1/gZg80l/Mhy5u/PGSzjR1YSf3/SYAU/slqTryJZg1V8z3hNHDlZxH/N4FQcWRsDmIgnZ+cL+K8YXFyKJxMAU4kaEJ8NAnyZchWxDZjPBsy3a8lc3AbEp5Q4X+ZAQ8RvQHxKcfA5DTTFn8tz5svVFRuE+NLEtTX/Cv0PqvybGzKo8tWaBy3cmvO3VP4HxP/4sWpAfHMi3aJj8cngjvhkcE98y6CDQ4PPBsxnA+YbBodYNflsQHw2IL5hsIq+yWcD4rMB8Q2DPgYmnw2IzwbENwwGGJp8NiA+GxDfMBhi5OKzAfPZQL39YISRt4BoRKB418YRhs4KpLGPoPj4MsTAV8I0+iUsLr4M0HfVQI3/DIuHL330PEVU6wyi4uBLD12xDbTeKC42X7rGY/SF+LHHqJh86eDWXAc08Bxr9TkuFl/aaFkLSYX/sLiQKBeSYvClFatkj4srmdapZI0gnw2I/yM3oVKKuZt/wWNBmB82mNuLCfPZgPkxg5l/NbusDn99nR81mNrLKY89NmB+zGDiXs+fouv5s3s9x2r8QMMGmjlQYEWyBpo70SxLyiB/pFraTBgkz3TpQ6V+I94OMBAMoigKzw4SAKE0DQQIMXP30P530xqe8zgLyAT8vPsdfqjsP9X+yqfacZOP1f65Xh8s9MnGHq3AbAfef/DhEr1/vaPplr9/aR+vw8brMYv/AL4/uwFDMGAYixCOFH+8mhFLOGJBjCec8SDIFA6ZEOUKp1wIs4VjNsT5wjmfDxp90umjVp/1+rBZoN0Cbv/4vN8PHPzEw49cnMzn7YdOauoFYrfNY7f9YrnfYe+fpxw8ysmnHL02Z7/f0ncPZL9C+Oyn3378Xs///3PzYFUUhW3/F1Vk9XAjc/s/AIM31KoOfbueAAAAAElFTkSuQmCC',
  137: 'data:image/png;base64,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',
}

const MIN_TX_CONFIRMATIONS = 3;

const monthMap = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

const pad00 = (input) => {
  return input.toString().padStart(2, '0');
}

const formatDate = (epoch) => {
  let date = new Date(epoch * 1000);
  return `${pad00(date.getDate())} ${monthMap[date.getMonth()]} ${pad00(date.getHours())}:${pad00(date.getMinutes())}:${pad00(date.getSeconds())}`;
}

const getEpoch = (d) => Math.floor((d || new Date()).getTime()/1000);

let showNetworkSelectDialog = () => {
  bootbox.dialog({ 
    message: `
    <div class="text-white select-none text-center">
      <div>Devil's Chest support the following networks</div>
      <div class="flex text-smaller">
        ${
            CHAINS.filter(c => c.mainnet === true).map(c => `
                <div
                    class="flex-auto flex flex-col m-4 cursor-pointer zoom"
                    style="flex-grow: 1;flex-basis: 0;"
                    @click="wallet.switchToChosenNetwork(${c.chainId})"
                >
                    <div class="py-2">
                    <img src="${CHAIN_PNG[+c.chainId]}" style="width: 64px; height: 64px;" />
                    </div>
                    <div>${c.shortName}</div>
                </div>
            `).join("")
        }
      </div>
    </div>`, 
    closeButton: false,
    centerVertical: true,
    className: 'web3-switch-network-modal',
  });
}

let NFTsMetadata = [
  {
    id: 1,
    name: "Big Bad Boar",
  },
  {
      id: 2,
      name: "The Fear BBQ",
  },
  {
      id: 3,
      name: "Charles the Octopus",
  }
];

const strIsInteger = (input) => {
  return /^\d+$/.test(`${input}`);
}

const strIsPositiveInteger = input => strIsInteger(input) && +input > 0;

const onIntegerOnlyInput = (e) => {
  const key = e.key;
  if(!/^\d$/.test(key)) return e.preventDefault();
}

const onFloatOnlyInput = (e) => {
  const key = e.key;
  if(!/^[\d\.]$/.test(key)) return e.preventDefault();
}

const MaxInt256 = ethers.constants.MaxInt256;
const ZeroBN = ethers.constants.Zero;
const OneBN = ethers.constants.One;

const bn = (input) => {
  if(input instanceof ethers.BigNumber) return input;
  try {
    return ethers.utils.parseEther(`${input}`);
  }
  catch(err) {
    return ZeroBN;
  }
}

const dialogPrompt = (message, value = '') => new Promise((resolve, reject) => {
  bootbox.prompt({
    title: message, 
    value,
    centerVertical: true,
    closeButton: false,
    callback: result => resolve(result),
    className: 'bootbox-dialog-prompt bootbox-dracula',
  });
})

const dialogAlert = message => bootbox.alert({
  size: "small",
  message: message,
  closeButton: false,
  centerVertical: true,
  className: 'bootbox-dialog-prompt bootbox-dialog-alert bootbox-dracula',
});

const dialogBusy = async (message, fn) => {
  vm.loading.MODAL = message;
  if(typeof fn != 'function') return;
  try {
    await fn();
  }
  catch(err){
    // const code = _.get(err, 'code');
    // if(code === 4001) return; // transaction rejected by user
    throw err;
  }
  finally {
    vm.loading.MODAL = false;
  }
}

const dialogConfirm = message =>
  new Promise((resolve) => {
    bootbox.confirm({
      message: message,
      buttons: {
        confirm: {
          label: 'Confirm',
          className: 'btn-success',
        },
        cancel: {
          label: 'Cancel',
          className: 'btn-danger',
        },
      },
      callback: resolve,
      closeButton: false,
      centerVertical: true,
      className: 'bootbox-dialog-prompt bootbox-dialog-confirm bootbox-dracula',
    });
  });

// const bloodNFTId = 17;

const sleep = ms => {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve();
    }, ms);
  })
}

const formatEther = (bn, short = true) => {
  try {
    return ethers.utils.formatEther(short ? bn.div(1e14).mul(1e14) : bn).replace(/\.0$/, '');
  }
  catch(err) {
    if(![null, undefined].includes(bn)) console.error(err);
    return "N/A";
  }
};

const formatWei = bn => {
  if(bn === null || bn === undefined) return "N/A";
  return bn.toString();
};

const countdownText = (timeLeft) => {
  if( !(timeLeft >= 1) ) return "ended";
  const d = Math.floor(timeLeft / (3600*24));
  const h = Math.floor(timeLeft % (3600*24) / 3600);
  const m = Math.floor(timeLeft % 3600 / 60);
  const s = Math.floor(timeLeft % 60);
  return `${d ? `${d}d` : ''} ${h}h ${m}m ${s}s`.trim();
}

const addTokenToMetamask = async () => {
  try {
    const tokenAddress = fear("fear_token").address;
    await blockchain.provider.send("wallet_watchAsset", {
      type: 'ERC20',
      options: {
        address: tokenAddress,
        symbol: 'FEAR',
        decimals: '18',
        image: 'https://assets.coingecko.com/coins/images/15825/small/fear-logo-400-400.png',
      },
    });
  }
  catch(err) {
    vm.setWarning(err);
  }
}

const setLoading = (k, v) => vm.loading[k] = !!v;

const showBloodCupGuide = () => {
  window.open("https://fear.io/updates/blood-comp-demystified/", "_blank");
}

const floor = Math.floor;

const firstCampaignStartEpoch = 1642163400;
const firstCampaignEndEpoch = 1644537600;
const BC_DISABLED = getEpoch() < firstCampaignStartEpoch;

const getPayouts = (participantsCount, buyin, bonus, equalLimit, itmPercentage) => {
  const getCorrectionFactor = (itmCount) => {
    if (itmCount <= 15) return [0.65, 0.92, 0.15];
    if (itmCount <= 40) return [0.53, 0.9, 0.6];
    if (itmCount <= 90) return [0.455, 0.89, 0.99];
    if (itmCount <= 300) return [0.45, 0.88, 0.99];
    if (itmCount <= 600) return [0.476, 1.05, 0.03];
    return [0.482, 1.1, 0];
  }
  const prizePool = participantsCount * buyin + bonus;
  if(participantsCount <= equalLimit) {
      return _.times(participantsCount, _.constant( floor(prizePool / participantsCount) ));
  }
  const itmCount = Math.floor(participantsCount * itmPercentage / 100 + 2); // number of winners
  const [A, B, C] = getCorrectionFactor(itmCount);
  // Calculate rought payouts
  const divider = A * Math.sqrt(B * itmCount) + C;
  const payouts = _.range(itmCount).map(i => floor(prizePool * (100 / (i + 2) + 1) / divider / 100));
  // Spreading the remainders / correction
  var total = 0;
  var counter = 0;
  for (let i = 0; i < itmCount; i++) {
      total += payouts[i];
  } 
  while (prizePool > total) {
      let diff = floor((prizePool - total) / itmCount);
      if (diff == 0) diff = 1;
      payouts[counter % itmCount] += diff;
      total += diff;
      counter++;
  }
  while (total > prizePool) {
      let diff = Math.floor((total - prizePool) / itmCount);
      if (diff == 0) diff = 1;
      payouts[counter % itmCount] -= diff;
      total -= diff;
      counter++;
  }
  return payouts;
}

const medals = ["🥇", "🥈", "🥉"];

const svgFaCheck = `
<svg width="1rem" height="1rem" color="#fa0" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="circle-check" class="svg-inline--fa fa-circle-check" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM371.8 211.8l-128 128C238.3 345.3 231.2 348 224 348s-14.34-2.719-19.81-8.188l-64-64c-10.91-10.94-10.91-28.69 0-39.63c10.94-10.94 28.69-10.94 39.63 0L224 280.4l108.2-108.2c10.94-10.94 28.69-10.94 39.63 0C382.7 183.1 382.7 200.9 371.8 211.8z"></path></svg>
`;

const svgFaCircleInfo = `
<svg width="1rem" height="1rem" color="#fa0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 128c17.67 0 32 14.33 32 32c0 17.67-14.33 32-32 32S224 177.7 224 160C224 142.3 238.3 128 256 128zM296 384h-80C202.8 384 192 373.3 192 360s10.75-24 24-24h16v-64H224c-13.25 0-24-10.75-24-24S210.8 224 224 224h32c13.25 0 24 10.75 24 24v88h16c13.25 0 24 10.75 24 24S309.3 384 296 384z"/></svg>
`;

const svgFaWarning = `
<svg width="1rem" height="1rem" color="#fa0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
`;

const getBloodPriceInFear = async (exContract, bloodTokenId = 17, fearTokenAddress = "0xa2CA40DBe72028D3Ac78B5250a8CB8c404e7Fb8C") => {
  const exchangeRate = await exContract.getTradableNftExchangeRate(bloodTokenId);
  const bloodPrices = _.zipObject(exchangeRate[0], exchangeRate[1]);
  return bloodPrices[fearTokenAddress];
}

const formatFeePercent = feeBN => {
  return 100 * ( feeBN.toNumber() ) / 1000;
}

const BNMin = (...BNList) => BNList.map(i => bn(i)).reduce((a, b) => (a.lt(b) ? a : b));
const BNMax = (...BNList) => BNList.map(i => bn(i)).reduce((a, b) => (a.gt(b) ? a : b));

const BC_ENABLED = false;